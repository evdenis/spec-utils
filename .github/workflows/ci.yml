name: CI

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ '*' ]

jobs:
  test:
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        include:
          - perl-version: '5.38.5'
            kernel-version: '4.19.42'
            module: 'fs/efivarfs'
          - perl-version: '5.40.3'
            kernel-version: '5.1.1'
            module: 'fs/exportfs'
          - perl-version: '5.42.0'
            kernel-version: '4.14.118'
            module: 'fs/tracefs'

    env:
      KERNEL_VERSION: ${{ matrix.kernel-version }}
      MODULE_TO_TEST: ${{ matrix.module }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Perl
        uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: ${{ matrix.perl-version }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libelf-dev build-essential bc kmod cpio flex bison libssl-dev

      - name: Cache Perl modules
        uses: actions/cache@v5
        with:
          path: ~/perl5
          key: ${{ runner.os }}-perl-${{ matrix.perl-version }}-${{ hashFiles('cpanfile') }}
          restore-keys: |
            ${{ runner.os }}-perl-${{ matrix.perl-version }}-

      - name: Cache kernel sources
        uses: actions/cache@v5
        with:
          path: linux-${{ matrix.kernel-version }}
          key: ${{ runner.os }}-kernel-${{ matrix.kernel-version }}
          restore-keys: |
            ${{ runner.os }}-kernel-

      - name: Install cpanm and Perl dependencies
        run: |
          cpan App::cpanminus
          cpanm --local-lib=~/perl5 local::lib
          eval $(perl -I ~/perl5/lib/perl5/ -Mlocal::lib)
          cpanm --quiet --notest --installdeps --with-all-features .
          cpanm --quiet --notest Devel::Cover::Report::Coveralls

      - name: Run tests with coverage
        run: |
          eval $(perl -I ~/perl5/lib/perl5/ -Mlocal::lib)
          cover -test

      - name: Upload coverage to Coveralls
        if: success()
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        run: |
          eval $(perl -I ~/perl5/lib/perl5/ -Mlocal::lib)
          cover -ignore_re=^/ -ignore_re=^t -report coveralls || true
